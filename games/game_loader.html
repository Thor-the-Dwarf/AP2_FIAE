<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Spiellader</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        .loading {
            font-family: sans-serif;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .error {
            color: #f87171;
            text-align: center;
            padding: 2rem;
        }
    </style>
</head>

<body>
    <div id="status" class="loading">Inhalt wird geladen...</div>

    <script>
        (async function () {
            const params = new URLSearchParams(window.location.search);
            const filePath = params.get('file');
            const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/games/'));

            if (!filePath) {
                showError('Keine Datei angegeben.');
                return;
            }

            try {
                let data = null;
                const storageKey = 'game_payload_' + filePath;

                // 1. Versuch: Daten aus sessionStorage (gepuffert vom Host)
                const cached = sessionStorage.getItem(storageKey);
                if (cached) {
                    try {
                        data = JSON.parse(cached);
                        const hasType = data && typeof data === 'object' && (data.game_type || data.gameType);
                        if (!hasType) {
                            data = null;
                        } else {
                            console.log('Spiel-Daten aus Cache geladen:', filePath);
                        }
                    } catch (e) {
                        console.warn('Fehler beim Parsen der Cache-Daten');
                    }
                }

                // 2. Fallback: Datei laden
                if (!data) {
                    const res = await fetch(basePath + '/' + filePath);
                    if (!res.ok) throw new Error(`Ladefehler: ${res.status}`);
                    data = await res.json();
                }

                // 3. Spiel-Typ bestimmen
                const gameType = data.game_type || data.gameType;
                if (!gameType) throw new Error('Unbekannter Spiel-Typ (kein game_type im JSON).');

                // 3. Mapping GameType -> HTML
                const mapping = {
                    'escape_game': 'Escape-Game.html',
                    'matching_puzzle': 'matching_puzzle.html',
                    'quick_quiz': 'quick_quiz.html',
                    'sortier_spiel': 'sortier_spiel.html',
                    'word_association_web': 'word_association_web.html',
                    'wer_bin_ich': 'wer_bin_ich.html',
                    'what_and_why': 'what_and_why.html'
                };

                const targetHtml = mapping[gameType];
                if (!targetHtml) throw new Error(`Kein Template für Spieltyp "${gameType}" gefunden.`);

                // 4. Payload speichern für GameBase
                // Wir speichern den Pfad, GameBase lädt ihn dann selbst (oder wir übergeben das Objekt)
                sessionStorage.setItem('game_payload_id', filePath);

                // 5. Weiterleitung (absolute path from current location)
                const currentDir = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
                window.location.href = currentDir + targetHtml;

            } catch (e) {
                showError(e.message);
            }

            function showError(msg) {
                const isFile = window.location.protocol === 'file:';
                const help = isFile
                    ? 'Du hast die Datei per file:// geöffnet. Der Browser blockiert lokale Fetches. Öffne die Seite über http:// oder starte Chrome mit --allow-file-access-from-files.'
                    : 'Bitte versuche es erneut.';
                document.getElementById('status').innerHTML = `
                    <div class="error">
                        <h3>Inhalt konnte nicht geladen werden</h3>
                        <p>${msg}</p>
                        <p>${help}</p>
                    </div>`;
            }
        })();
    </script>
</body>

</html>
